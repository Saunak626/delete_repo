<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub ä»“åº“æ‰¹é‡ç®¡ç†å·¥å…·</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Select extension CSS -->
    <link href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        .repo-table th, .repo-table td {
            vertical-align: middle;
            padding: 8px !important;
            white-space: nowrap;
        }
        .repo-table th {
            font-size: 0.9em;
            min-width: 80px;
        }
        .repo-table .col-checkbox {
            width: 60px;
            text-align: center;
        }
        .repo-table .col-name {
            min-width: 200px;
            max-width: 300px;
        }
        .repo-table .col-link {
            width: 80px;
        }
        .repo-table .col-score {
            width: 60px;
            text-align: center;
        }
        .repo-table .col-status {
            width: 60px;
            text-align: center;
        }
        .repo-table .col-date {
            width: 100px;
        }
        .repo-table .col-days {
            width: 80px;
            text-align: right;
        }
        .repo-table .col-note {
            min-width: 150px;
            max-width: 250px;
            word-wrap: break-word;
            white-space: normal;
        }
        .status-badge {
            font-size: 0.8em;
            margin: 2px;
        }
        .selected-row {
            background-color: #e3f2fd !important;
        }
        .locked-row {
            background-color: #fff3e0 !important;
        }
        .loading {
            display: none;
        }
        .token-input {
            font-family: monospace;
        }
        .risk-score {
            font-weight: bold;
        }
        .risk-0 { color: #28a745; }
        .risk-1 { color: #ffc107; }
        .risk-2 { color: #fd7e14; }
        .risk-3 { color: #dc3545; }
        .risk-4 { color: #6f42c1; }
        
        /* æ‰¹é‡é€‰æ‹©è¯´æ˜ */
        .selection-help {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .selection-help h6 {
            margin-bottom: 10px;
            font-weight: bold;
        }
        .selection-help ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        .selection-help li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    ğŸ“¦ GitHub ä»“åº“æ‰¹é‡ç®¡ç†å·¥å…·
                </h1>
                
                <div class="alert alert-info">
                    <strong>âœ¨ æ–°åŠŸèƒ½äº®ç‚¹ï¼š</strong>
                    æ”¯æŒè¡¨æ ¼æ’åºä¸”ä¸ä¼šé‡ç½® | æ”¯æŒæ‹–é€‰å¤šä¸ªæ¡ç›® | æ›´ç¨³å®šçš„çŠ¶æ€ç®¡ç†
                </div>

                <!-- Token è¾“å…¥ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ”‘ GitHub Token</h5>
                        <div class="input-group">
                            <input type="password" id="tokenInput" class="form-control token-input" 
                                   placeholder="è¯·è¾“å…¥ GitHub Personal Access Tokenï¼ˆéœ€ repo & delete_repo æƒé™ï¼‰">
                            <button id="fetchButton" class="btn btn-primary">
                                <span class="loading spinner-border spinner-border-sm me-2"></span>
                                è·å–ä»“åº“åˆ—è¡¨
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ‰¹é‡é€‰æ‹©è¯´æ˜ -->
                <div id="selectionHelp" class="selection-help" style="display: none;">
                    <h6>ğŸ–±ï¸ æ‰¹é‡é€‰æ‹©æ“ä½œæŒ‡å—</h6>
                    <ul>
                        <li><strong>æ‹–æ‹½é€‰æ‹©ï¼š</strong> åœ¨è¡¨æ ¼è¡Œä¸ŠæŒ‰ä½é¼ æ ‡å·¦é”®æ‹–æ‹½å¯é€‰æ‹©å¤šè¡Œ</li>
                        <li><strong>è¿ç»­é€‰æ‹©ï¼š</strong> ç‚¹å‡»ç¬¬ä¸€è¡Œï¼Œç„¶åæŒ‰ä½ Shift ç‚¹å‡»æœ€åä¸€è¡Œ</li>
                        <li><strong>å•ç‹¬å‹¾é€‰ï¼š</strong> ç›´æ¥ç‚¹å‡»å‰ä¸‰åˆ—çš„å¤é€‰æ¡†</li>
                        <li><strong>æ‰¹é‡æŒ‰é’®ï¼š</strong> ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®å¯¹å½“å‰ç­›é€‰ç»“æœè¿›è¡Œæ‰¹é‡æ“ä½œ</li>
                    </ul>
                </div>

                <!-- æ“ä½œé¢æ¿ -->
                <div id="operationPanel" class="card mb-4" style="display: none;">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">ç­›é€‰é£é™©åˆ†æ•° â‰¥</label>
                                <input type="range" id="riskFilter" class="form-range" 
                                       min="0" max="4" value="0">
                                <div class="d-flex justify-content-between">
                                    <small>0</small><small>1</small><small>2</small><small>3</small><small>4</small>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">æ‰¹é‡æ“ä½œ</label>
                                <div class="btn-group w-100">
                                    <button id="selectAllBtn" class="btn btn-outline-success">âœ… å…¨é€‰åˆ é™¤</button>
                                    <button id="selectByRiskBtn" class="btn btn-outline-warning">âš™ï¸ æŒ‰åˆ†æ•°é€‰ä¸­</button>
                                    <button id="resetBtn" class="btn btn-outline-secondary">ğŸ”„ é‡ç½®é€‰æ‹©</button>
                                    <button id="executeArchiveBtn" class="btn btn-success">ğŸ“¦ æ‰§è¡Œå½’æ¡£</button>
                                    <button id="executeDeleteBtn" class="btn btn-danger">ğŸ—‘ï¸ æ‰§è¡Œåˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»“åº“è¡¨æ ¼ -->
                <div id="tableContainer" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="repoTable" class="table table-striped table-hover repo-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="col-checkbox">ğŸ”’<br>é”å®š</th>
                                            <th class="col-checkbox">ğŸ“¦<br>å½’æ¡£</th>
                                            <th class="col-checkbox">ğŸ—‘ï¸<br>åˆ é™¤</th>
                                            <th class="col-name">ä»“åº“å</th>
                                            <th class="col-link">é“¾æ¥</th>
                                            <th class="col-score">é£é™©<br>åˆ†æ•°</th>
                                            <th class="col-status">ç§æœ‰</th>
                                            <th class="col-status">Fork</th>
                                            <th class="col-status">å·²<br>å½’æ¡£</th>
                                            <th class="col-status">Stars</th>
                                            <th class="col-date">æœ€è¿‘<br>æ´»åŠ¨</th>
                                            <th class="col-days">æœªæ´»åŠ¨<br>(å¤©)</th>
                                            <th class="col-note">å¤‡æ³¨</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>è­¦å‘Šï¼šåˆ é™¤æ“ä½œä¸å¯é€†ï¼</strong>
                    </div>
                    <div id="lockedReposList"></div>
                    <div id="deleteReposList"></div>
                    <div class="mb-3">
                        <label class="form-label">è¯·è¾“å…¥ <strong>ç¡®è®¤åˆ é™¤</strong> ä»¥ç»§ç»­ï¼š</label>
                        <input type="text" id="deleteConfirmInput" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Select extension JS -->
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

    <script>
        let repoTable;
        let repoData = [];
        let reposToDelete = [];

        $(document).ready(function() {
            // è·å–ä»“åº“åˆ—è¡¨
            $('#fetchButton').click(fetchRepos);
            
            // æ‰¹é‡æ“ä½œ
            $('#selectAllBtn').click(() => bulkOperation('delete_selected', true));
            $('#selectByRiskBtn').click(selectByRisk);
            $('#resetBtn').click(() => {
                bulkOperation('archive_selected', false);
                bulkOperation('delete_selected', false);
            });
            
            // æ‰§è¡Œæ“ä½œ
            $('#executeArchiveBtn').click(executeArchive);
            $('#executeDeleteBtn').click(showDeleteModal);
            $('#confirmDeleteBtn').click(executeDelete);
            
            // é£é™©åˆ†æ•°ç­›é€‰
            $('#riskFilter').on('input', filterByRisk);
            
            // å›è½¦é”®å¿«æ·æ“ä½œ
            $('#tokenInput').keypress(function(e) {
                if(e.which == 13) fetchRepos();
            });
            $('#deleteConfirmInput').keypress(function(e) {
                if(e.which == 13 && $(this).val() === 'ç¡®è®¤åˆ é™¤') executeDelete();
            });
        });

        function fetchRepos() {
            const token = $('#tokenInput').val().trim();
            if (!token) {
                alert('è¯·è¾“å…¥ GitHub Token');
                return;
            }

            $('#fetchButton .loading').show();
            $('#fetchButton').prop('disabled', true);

            $.ajax({
                url: '/api/fetch_repos',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({token: token}),
                success: function(response) {
                    repoData = response.repos;
                    initializeTable();
                    $('#selectionHelp').show();
                    $('#operationPanel').show();
                    $('#tableContainer').show();
                    showToast('æˆåŠŸè·å– ' + repoData.length + ' ä¸ªä»“åº“', 'success');
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'è·å–å¤±è´¥';
                    showToast(error, 'danger');
                },
                complete: function() {
                    $('#fetchButton .loading').hide();
                    $('#fetchButton').prop('disabled', false);
                }
            });
        }

        function initializeTable() {
            if (repoTable) {
                repoTable.destroy();
            }

            repoTable = $('#repoTable').DataTable({
                data: repoData,
                columns: [
                    {
                        data: 'lock_repo',
                        render: function(data, type, row, meta) {
                            return `<input type="checkbox" class="form-check-input lock-checkbox" 
                                    ${data ? 'checked' : ''} data-repo="${row.full_name}">`;
                        },
                        orderable: false
                    },
                    {
                        data: 'archive_selected',
                        render: function(data, type, row, meta) {
                            return `<input type="checkbox" class="form-check-input archive-checkbox" 
                                    ${data ? 'checked' : ''} data-repo="${row.full_name}">`;
                        },
                        orderable: false
                    },
                    {
                        data: 'delete_selected',
                        render: function(data, type, row, meta) {
                            return `<input type="checkbox" class="form-check-input delete-checkbox" 
                                    ${data ? 'checked' : ''} data-repo="${row.full_name}">`;
                        },
                        orderable: false
                    },
                    {data: 'full_name'},
                    {
                        data: 'repo_url',
                        render: function(data, type, row) {
                            return `<a href="${data}" target="_blank" class="btn btn-sm btn-outline-primary">è®¿é—®</a>`;
                        },
                        orderable: false
                    },
                    {
                        data: 'suggestion_score',
                        render: function(data, type, row) {
                            return `<span class="badge bg-secondary risk-${data}">${data}</span>`;
                        }
                    },
                    {
                        data: 'private',
                        render: function(data) {
                            return data ? '<span class="badge bg-warning">ç§æœ‰</span>' : '';
                        }
                    },
                    {
                        data: 'fork',
                        render: function(data) {
                            return data ? '<span class="badge bg-info">Fork</span>' : '';
                        }
                    },
                    {
                        data: 'archived',
                        render: function(data) {
                            return data ? '<span class="badge bg-secondary">å·²å½’æ¡£</span>' : '';
                        }
                    },
                    {data: 'stars'},
                    {data: 'last_activity_at'},
                    {data: 'days_inactive'},
                    {data: 'note'}
                ],
                pageLength: 25,
                order: [[11, 'desc']],  // æŒ‰æœªæ´»åŠ¨å¤©æ•°æ’åº
                select: {
                    style: 'multi',
                    selector: 'td:not(:first-child):not(:nth-child(2)):not(:nth-child(3))'
                },
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json'
                },
                scrollCollapse: true,
                stateSave: false,
                drawCallback: function(settings) {
                    // é˜²æ­¢è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨
                    if (this.api().page.info().page > 0) {
                        return;
                    }
                },
                rowCallback: function(row, data) {
                    if (data.lock_repo) {
                        $(row).addClass('locked-row');
                    }
                    if (data.delete_selected || data.archive_selected) {
                        $(row).addClass('selected-row');
                    }
                }
            });

            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            $('#repoTable').on('change', '.lock-checkbox, .archive-checkbox, .delete-checkbox', function() {
                const checkbox = $(this);
                const repoName = checkbox.data('repo');
                const type = checkbox.hasClass('lock-checkbox') ? 'lock_repo' : 
                            checkbox.hasClass('archive-checkbox') ? 'archive_selected' : 'delete_selected';
                const checked = checkbox.is(':checked');

                // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                const scrollTop = $(window).scrollTop();
                
                updateRepoSelection(repoName, type, checked);
                
                // æ¢å¤æ»šåŠ¨ä½ç½®
                setTimeout(() => {
                    $(window).scrollTop(scrollTop);
                }, 50);
            });

            // å¢å¼ºçš„è¡Œé€‰æ‹©åŠŸèƒ½
            let isDragging = false;
            let dragStartRow = null;
            
            $('#repoTable tbody').on('mousedown', 'tr', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æˆ–é“¾æ¥ï¼Œè·³è¿‡
                if ($(e.target).is('input[type="checkbox"]') || $(e.target).closest('a').length) {
                    return;
                }
                
                isDragging = true;
                dragStartRow = this;
                $(this).addClass('table-primary');
                e.preventDefault(); // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
            });

            $('#repoTable tbody').on('mouseover', 'tr', function(e) {
                if (!isDragging || !dragStartRow) return;
                
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                $('#repoTable tbody tr').removeClass('table-primary');
                
                // è®¡ç®—é€‰æ‹©èŒƒå›´
                const startIndex = repoTable.row(dragStartRow).index();
                const endIndex = repoTable.row(this).index();
                const start = Math.min(startIndex, endIndex);
                const end = Math.max(startIndex, endIndex);
                
                // é«˜äº®é€‰æ‹©èŒƒå›´
                for (let i = start; i <= end; i++) {
                    $(repoTable.row(i).node()).addClass('table-primary');
                }
            });

            $(document).on('mouseup', function(e) {
                if (!isDragging) return;
                
                isDragging = false;
                const $highlightedRows = $('#repoTable tbody tr.table-primary');
                
                if ($highlightedRows.length > 0) {
                    let all_selected = true;
                    $highlightedRows.each(function() {
                        const rowData = repoTable.row(this).data();
                        if (rowData && !rowData.delete_selected) {
                            all_selected = false;
                        }
                    });

                    const new_state = !all_selected;
                    const selections = {};

                    $highlightedRows.each(function() {
                        const rowData = repoTable.row(this).data();
                        if (rowData) {
                            rowData.delete_selected = new_state;
                            selections[rowData.full_name] = {delete_selected: new_state};
                        }
                    });
                    
                    if(Object.keys(selections).length > 0) {
                        updateMultipleSelections(selections);
                    }
                }
                
                // æ¸…é™¤é«˜äº®
                $('#repoTable tbody tr').removeClass('table-primary');
                dragStartRow = null;
            });

            // Shift+ç‚¹å‡»è¿›è¡ŒèŒƒå›´é€‰æ‹©
            $('#repoTable tbody').on('click', 'tr', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æˆ–é“¾æ¥ï¼Œè·³è¿‡
                if ($(e.target).is('input[type="checkbox"]') || $(e.target).closest('a').length) {
                    return;
                }
                
                if (e.shiftKey && window.lastSelectedRow !== undefined) {
                    const currentIndex = repoTable.row(this).index();
                    const start = Math.min(window.lastSelectedRow, currentIndex);
                    const end = Math.max(window.lastSelectedRow, currentIndex);
                    
                    const selections = {};
                    for (let i = start; i <= end; i++) {
                        const data = repoTable.row(i).data();
                        if (data) {
                            data.delete_selected = true;
                            selections[data.full_name] = {delete_selected: true};
                        }
                    }
                    
                    updateMultipleSelections(selections);
                }
                
                window.lastSelectedRow = repoTable.row(this).index();
            });
        }

        function updateRepoSelection(repoName, type, checked) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            const repo = repoData.find(r => r.full_name === repoName);
            if (repo) {
                repo[type] = checked;
            }

            // å‘é€åˆ°æœåŠ¡å™¨
            const selections = {};
            selections[repoName] = {[type]: checked};

            $.ajax({
                url: '/api/update_selections',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({selections: selections})
            });

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼è¡Œæ ·å¼ï¼Œä¿æŒå½“å‰é¡µé¢å’Œæ’åº
            repoTable.rows().invalidate().draw(false);
        }

        function updateMultipleSelections(selections) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            Object.keys(selections).forEach(repoName => {
                const repo = repoData.find(r => r.full_name === repoName);
                if (repo) {
                    Object.assign(repo, selections[repoName]);
                }
            });

            // å‘é€åˆ°æœåŠ¡å™¨
            $.ajax({
                url: '/api/update_selections',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({selections: selections}),
                success: function() {
                    repoTable.rows().invalidate().draw(false);
                    showToast(`å·²é€‰æ‹© ${Object.keys(selections).length} ä¸ªä»“åº“`, 'info');
                }
            });
        }

        function bulkOperation(type, value) {
            const visibleData = repoTable.rows({filter: 'applied'}).data().toArray();
            const selections = {};

            visibleData.forEach(repo => {
                repo[type] = value;
                selections[repo.full_name] = {[type]: value};
            });

            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const scrollTop = $(window).scrollTop();

            $.ajax({
                url: '/api/update_selections',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({selections: selections}),
                success: function() {
                    repoTable.rows().invalidate().draw(false);
                    showToast(`å·²${value ? 'é€‰ä¸­' : 'å–æ¶ˆ'}å¯è§çš„ ${visibleData.length} ä¸ªä»“åº“`, 'info');
                    
                    // æ¢å¤æ»šåŠ¨ä½ç½®
                    setTimeout(() => {
                        $(window).scrollTop(scrollTop);
                    }, 50);
                }
            });
        }

        function selectByRisk() {
            const riskThreshold = parseInt($('#riskFilter').val());
            const visibleData = repoTable.rows({filter: 'applied'}).data().toArray();
            const selections = {};

            visibleData.forEach(repo => {
                if (repo.suggestion_score >= riskThreshold) {
                    repo.delete_selected = true;
                    selections[repo.full_name] = {delete_selected: true};
                }
            });

            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const scrollTop = $(window).scrollTop();

            $.ajax({
                url: '/api/update_selections',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({selections: selections}),
                success: function() {
                    repoTable.rows().invalidate().draw(false);
                    showToast(`å·²é€‰ä¸­é£é™©åˆ†æ•° â‰¥ ${riskThreshold} çš„ä»“åº“`, 'warning');
                    
                    // æ¢å¤æ»šåŠ¨ä½ç½®
                    setTimeout(() => {
                        $(window).scrollTop(scrollTop);
                    }, 50);
                }
            });
        }

        function filterByRisk() {
            const riskThreshold = parseInt($('#riskFilter').val());
            repoTable.column(5).search(riskThreshold === 0 ? '' : '^[' + riskThreshold + '-4]$', true, false).draw();
        }

        function executeArchive() {
            const toArchive = repoData.filter(r => r.archive_selected);
            if (toArchive.length === 0) {
                showToast('æ²¡æœ‰é€‰ä¸­è¦å½’æ¡£çš„ä»“åº“', 'warning');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å½’æ¡£ ${toArchive.length} ä¸ªä»“åº“å—ï¼Ÿ`)) return;

            $.ajax({
                url: '/api/execute_archive',
                method: 'POST',
                success: function(response) {
                    showToast(`æˆåŠŸå½’æ¡£ ${response.archived_count} ä¸ªä»“åº“`, 'success');
                    if (response.errors.length > 0) {
                        console.error('å½’æ¡£é”™è¯¯:', response.errors);
                    }
                    repoTable.draw(false);
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'å½’æ¡£å¤±è´¥';
                    showToast(error, 'danger');
                }
            });
        }

        function showDeleteModal() {
            const toDelete = repoData.filter(r => r.delete_selected);
            if (toDelete.length === 0) {
                showToast('æ²¡æœ‰é€‰ä¸­è¦åˆ é™¤çš„ä»“åº“', 'warning');
                return;
            }
            
            reposToDelete = toDelete.map(r => r.full_name);

            const lockedRepos = toDelete.filter(r => r.lock_repo);
            
            if (lockedRepos.length > 0) {
                const lockedList = lockedRepos.map(r => `
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2">ğŸ”’</span>
                        <code class="text-muted">${r.full_name}</code>
                    </div>
                `).join('');
                $('#lockedReposList').html(`
                    <div class="alert alert-warning">
                        <strong>ä»¥ä¸‹ä»“åº“è¢«é”å®šï¼Œæ— æ³•åˆ é™¤ï¼š</strong>
                        <div class="mt-2">${lockedList}</div>
                    </div>
                `);
            } else {
                $('#lockedReposList').empty();
            }

            const deleteList = toDelete.filter(r => !r.lock_repo).map(r => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                    <code class="text-dark">${r.full_name}</code>
                    <div>
                        <span class="badge bg-secondary risk-${r.suggestion_score}">${r.suggestion_score}</span>
                        ${r.private ? '<span class="badge bg-warning ms-1">ç§æœ‰</span>' : ''}
                        ${r.fork ? '<span class="badge bg-info ms-1">Fork</span>' : ''}
                    </div>
                </div>
            `).join('');
            $('#deleteReposList').html(`
                <div class="alert alert-danger">
                    <strong>âš ï¸ å°†è¦åˆ é™¤çš„ä»“åº“ (${toDelete.length - lockedRepos.length} ä¸ª)ï¼š</strong>
                    <div class="mt-3 max-height-300" style="max-height: 300px; overflow-y: auto;">
                        ${deleteList}
                    </div>
                </div>
            `);

            $('#deleteConfirmInput').val('');
            $('#deleteModal').modal('show');
        }

        function executeDelete() {
            const confirmText = $('#deleteConfirmInput').val().trim();
            if (confirmText !== 'ç¡®è®¤åˆ é™¤') {
                showToast('è¯·è¾“å…¥"ç¡®è®¤åˆ é™¤"', 'warning');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            $('#confirmDeleteBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> åˆ é™¤ä¸­...');

            $.ajax({
                url: '/api/execute_delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ repos_to_delete: reposToDelete }),
                success: function(response) {
                    // 1. å…ˆæ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast(`æˆåŠŸåˆ é™¤ ${response.deleted_count} ä¸ªä»“åº“`, 'success');
                    
                    // 2. å…³é—­æ¨¡æ€æ¡†
                    $('#deleteModal').modal('hide');

                    if (response.errors && response.errors.length > 0) {
                        console.error('åˆ é™¤é”™è¯¯:', response.errors);
                        showToast(`éƒ¨åˆ†ä»“åº“åˆ é™¤å¤±è´¥ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°`, 'warning');
                    }

                    // 3. ç›´æ¥åœ¨å‰ç«¯æ›´æ–°æ•°æ®ï¼Œå®ç°å³æ—¶åˆ·æ–°
                    repoData = repoData.filter(repo => !reposToDelete.includes(repo.full_name));
                    
                    // 4. é‡æ–°æ¸²æŸ“è¡¨æ ¼
                    initializeTable();
                    
                    // 5. æ¸…ç©ºå¾…åˆ é™¤åˆ—è¡¨
                    reposToDelete = [];
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'åˆ é™¤å¤±è´¥';
                    if (xhr.responseJSON?.locked_repos) {
                        showToast('å­˜åœ¨è¢«é”å®šçš„ä»“åº“ï¼Œæ— æ³•åˆ é™¤', 'warning');
                    } else {
                        showToast(error, 'danger');
                    }
                },
                complete: function() {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    $('#confirmDeleteBtn').prop('disabled', false).text('ç¡®è®¤åˆ é™¤');
                }
            });
        }

        function showToast(message, type = 'info') {
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);

            if (!$('#toastContainer').length) {
                $('body').append('<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>');
            }

            $('#toastContainer').append(toast);
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();

            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    </script>
</body>
</html> 